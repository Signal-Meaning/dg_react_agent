# Migration Guide: v0.x to v1.0.0

## Overview

This guide helps you migrate from dg_react_agent v0.x to v1.0.0. While v1.0.0 introduces significant new features, most existing implementations should work with minimal changes.

## Quick Migration Checklist

- [ ] **Update Dependencies**: Install v1.0.0
- [ ] **Review Breaking Changes**: Check for any breaking changes
- [ ] **Test Existing Functionality**: Ensure current features still work
- [ ] **Add New Features** (Optional): Implement VAD events and lazy reconnection
- [ ] **Update Tests**: Update tests for new features
- [ ] **Deploy**: Deploy to staging first, then production

## Step-by-Step Migration

### Step 1: Update Dependencies

```bash
# Update to v1.0.0
npm install deepgram-voice-interaction-react@^1.0.0

# Or with yarn
yarn add deepgram-voice-interaction-react@^1.0.0
```

### Step 2: Review Your Current Implementation

Before making changes, review your current implementation:

```typescript
// Your current v0.x implementation
<DeepgramVoiceInteraction
  apiKey="your-api-key"
  agentOptions={{
    language: 'en',
    voice: 'aura-asteria-en',
    instructions: 'You are a helpful assistant.'
  }}
  onUserStartedSpeaking={() => console.log('User started')}
  onAgentResponse={(response) => console.log('Agent:', response)}
/>
```

### Step 3: Test Existing Functionality

Your existing implementation should continue to work without changes:

```typescript
// This should work exactly the same in v1.0.0
<DeepgramVoiceInteraction
  apiKey="your-api-key"
  agentOptions={{
    language: 'en',
    voice: 'aura-asteria-en',
    instructions: 'You are a helpful assistant.'
  }}
  onUserStartedSpeaking={() => console.log('User started')}
  onAgentResponse={(response) => console.log('Agent:', response)}
/>
```

### Step 4: Add New Features (Optional)

#### Add VAD Event Handling

```typescript
// Enhanced v1.0.0 implementation with VAD events
<DeepgramVoiceInteraction
  apiKey="your-api-key"
  agentOptions={{
    language: 'en',
    voice: 'aura-asteria-en',
    instructions: 'You are a helpful assistant.',
    utteranceEndMs: 2000,  // NEW: VAD configuration
    vadThreshold: 0.7       // NEW: VAD sensitivity
  }}
  onUserStartedSpeaking={() => console.log('User started')}
  onUserStoppedSpeaking={() => console.log('User stopped')}  // NEW: VAD callback
  onUtteranceEnd={(data) => console.log('Utterance ended:', data)}  // NEW: VAD callback
  onVADEvent={(event) => console.log('VAD event:', event)}  // NEW: VAD callback
  onAgentResponse={(response) => console.log('Agent:', response)}
/>
```

#### Add State Management

```typescript
// Enhanced with state management
const [state, setState] = useState(null);

<DeepgramVoiceInteraction
  // ... existing props
  onStateChange={setState}  // NEW: State callback
/>

// Use enhanced state
const { 
  isUserSpeaking, 
  currentSpeechDuration, 
  conversationHistory 
} = state || {};
```

#### Add Lazy Reconnection

```typescript
// Enhanced with lazy reconnection
const deepgramRef = useRef(null);

const handleReconnection = async (text) => {
  await deepgramRef.current?.resumeWithText(text);  // NEW: Lazy reconnection
};

<DeepgramVoiceInteraction
  ref={deepgramRef}  // NEW: Ref for method access
  // ... existing props
/>
```

## Breaking Changes

### ⚠️ State Interface Changes

#### New State Properties
The state interface has been expanded with new properties. Existing code will continue to work, but you may want to utilize the new properties.

**Before (v0.x):**
```typescript
// Your existing state usage
const { isReady, agentState, isRecording } = state;
```

**After (v1.0.0):**
```typescript
// Enhanced state usage (optional)
const { 
  isReady, 
  agentState, 
  isRecording,
  isUserSpeaking,        // NEW: VAD state
  currentSpeechDuration, // NEW: VAD state
  utteranceEndData,      // NEW: VAD state
  conversationHistory,   // NEW: Context state
  sessionId             // NEW: Session state
} = state;
```

#### Migration Steps for State Changes
1. **No immediate action required** - new properties are optional
2. **Update TypeScript interfaces** if you're extending the state
3. **Utilize new VAD properties** for enhanced user experience

**Example:**
```typescript
// Before
const { isReady, agentState } = state;

// After (optional enhancement)
const { isReady, agentState, isUserSpeaking, utteranceEndData } = state;

// Use new VAD properties
if (isUserSpeaking) {
  console.log('User is currently speaking');
}

if (utteranceEndData) {
  console.log('Utterance ended:', utteranceEndData);
}
```

### ⚠️ Callback Signature Changes

#### New Callback Parameters
Some callbacks now include additional parameters for VAD events.

**Before (v0.x):**
```typescript
interface DeepgramVoiceInteractionProps {
  onUserStartedSpeaking?: () => void;
  onAgentSilent?: () => void;
  onAgentSpeaking?: () => void;
  onAgentResponse?: (response: string) => void;
  onError?: (error: string) => void;
}
```

**After (v1.0.0):**
```typescript
interface DeepgramVoiceInteractionProps {
  // Existing callbacks (unchanged)
  onUserStartedSpeaking?: () => void;
  onAgentSilent?: () => void;
  onAgentSpeaking?: () => void;
  onAgentResponse?: (response: string) => void;
  onError?: (error: string) => void;
  
  // NEW: VAD event callbacks
  onUserStoppedSpeaking?: () => void;
  onUtteranceEnd?: (data: UtteranceEndData) => void;
  onVADEvent?: (event: VADEvent) => void;
  
  // NEW: State change callback
  onStateChange?: (state: VoiceInteractionState) => void;
}
```

#### Migration Steps for Callbacks
1. **No immediate action required** - new callbacks are optional
2. **Add new callbacks** if you want VAD event handling
3. **Update TypeScript interfaces** if you're extending the props

**Example:**
```typescript
// Before
<DeepgramVoiceInteraction
  onUserStartedSpeaking={() => console.log('User started speaking')}
  onAgentResponse={(response) => console.log('Agent response:', response)}
/>

// After (with new VAD callbacks)
<DeepgramVoiceInteraction
  onUserStartedSpeaking={() => console.log('User started speaking')}
  onUserStoppedSpeaking={() => console.log('User stopped speaking')}  // NEW
  onUtteranceEnd={(data) => console.log('Utterance ended:', data)}    // NEW
  onVADEvent={(event) => console.log('VAD event:', event)}            // NEW
  onAgentResponse={(response) => console.log('Agent response:', response)}
/>
```

### ⚠️ Error Handling Changes

#### Enhanced Error Objects
Error handling has been improved with more detailed error information.

**Before (v0.x):**
```typescript
onError?: (error: string) => void;
```

**After (v1.0.0):**
```typescript
onError?: (error: string) => void; // Still supported
// Enhanced error handling available through state
// error property now includes more detailed information
```

#### Migration Steps for Error Handling
1. **No immediate action required** - existing error handling continues to work
2. **Enhance error handling** by utilizing the improved error state
3. **Add error recovery** using the new error handling capabilities

**Example:**
```typescript
// Before
const handleError = (error: string) => {
  console.error('Error:', error);
  setErrorMessage(error);
};

// After (enhanced)
const handleError = (error: string) => {
  console.error('Error:', error);
  setErrorMessage(error);
  
  // Enhanced error handling
  if (error.includes('WebSocket')) {
    // Handle WebSocket errors specifically
    attemptReconnection();
  } else if (error.includes('Audio')) {
    // Handle audio errors specifically
    resetAudioManager();
  }
};
```

## New Features Migration

### 🎤 Voice Activity Detection (VAD) Events

#### Basic VAD Implementation
```typescript
// Add VAD event handling to your existing implementation
<DeepgramVoiceInteraction
  // ... your existing props
  
  // NEW: VAD event callbacks
  onUserStoppedSpeaking={() => {
    console.log('User stopped speaking');
    // Handle user stopping speech
  }}
  
  onUtteranceEnd={(data) => {
    console.log('Utterance ended:', data);
    // Handle utterance completion
    if (data.isFinal && data.confidence > 0.8) {
      processUserUtterance(data);
    }
  }}
  
  onVADEvent={(event) => {
    console.log('VAD event:', event);
    // Handle all VAD events in one place
  }}
/>
```

#### Advanced VAD Usage
```typescript
// Advanced VAD implementation with state management
const [speechStats, setSpeechStats] = useState({
  totalSpeakingTime: 0,
  utteranceCount: 0,
  averageUtteranceLength: 0
});

const handleUtteranceEnd = (data: UtteranceEndData) => {
  setSpeechStats(prev => {
    const newTotalTime = prev.totalSpeakingTime + data.duration;
    const newCount = prev.utteranceCount + 1;
    
    return {
      totalSpeakingTime: newTotalTime,
      utteranceCount: newCount,
      averageUtteranceLength: newTotalTime / newCount
    };
  });
};

<DeepgramVoiceInteraction
  // ... your existing props
  onUtteranceEnd={handleUtteranceEnd}
  onStateChange={(state) => {
    // Access VAD state
    const { isUserSpeaking, currentSpeechDuration } = state;
    console.log('User speaking:', isUserSpeaking, 'Duration:', currentSpeechDuration);
  }}
/>
```

### 🔄 Lazy Reconnection with Context

#### Basic Reconnection
```typescript
// Add lazy reconnection to your existing implementation
const deepgramRef = useRef<DeepgramVoiceInteractionHandle>(null);

const handleReconnection = async (text: string) => {
  try {
    await deepgramRef.current?.resumeWithText(text);
    console.log('Reconnected with text:', text);
  } catch (error) {
    console.error('Reconnection failed:', error);
  }
};

<DeepgramVoiceInteraction
  ref={deepgramRef}  // NEW: Add ref for method access
  // ... your existing props
/>

// Use reconnection
<button onClick={() => handleReconnection("Continue our conversation")}>
  Reconnect
</button>
```

#### Advanced Context Management
```typescript
// Advanced context management
const [conversationHistory, setConversationHistory] = useState<ConversationMessage[]>([]);

const handleStateChange = (state: VoiceInteractionState) => {
  setConversationHistory(state.conversationHistory);
  
  // Access session information
  console.log('Session ID:', state.sessionId);
  console.log('Conversation length:', state.conversationHistory.length);
};

const analyzeConversation = () => {
  const userMessages = conversationHistory.filter(msg => msg.role === 'user');
  const agentMessages = conversationHistory.filter(msg => msg.role === 'assistant');
  
  console.log('Conversation Analysis:', {
    totalMessages: conversationHistory.length,
    userMessages: userMessages.length,
    agentMessages: agentMessages.length
  });
};

<DeepgramVoiceInteraction
  ref={deepgramRef}
  onStateChange={handleStateChange}  // NEW: State management
  // ... your existing props
/>
```

### 🎯 Enhanced State Management

#### State-driven UI Updates
```typescript
// Enhanced UI with state management
const VoiceUI = () => {
  const [state, setState] = useState<VoiceInteractionState | null>(null);
  
  return (
    <div>
      <DeepgramVoiceInteraction
        onStateChange={setState}  // NEW: State callback
        // ... your existing props
      />
      
      {/* Enhanced UI with VAD information */}
      {state?.isUserSpeaking && (
        <div className="speaking-indicator">
          Speaking for {state.currentSpeechDuration}ms
        </div>
      )}
      
      {state?.utteranceEndData && (
        <div className="utterance-info">
          Last utterance: {state.utteranceEndData.duration}ms
        </div>
      )}
      
      {state?.conversationHistory.length > 0 && (
        <div className="conversation-stats">
          Messages: {state.conversationHistory.length}
        </div>
      )}
    </div>
  );
};
```

## Common Migration Issues

### Issue 1: TypeScript Errors

**Problem:** TypeScript errors due to new state properties.

**Solution:**
```typescript
// Update your state interface extensions
interface MyCustomState extends VoiceInteractionState {
  // Your custom properties
  customProperty: string;
}

// Or use the new properties directly
const { isUserSpeaking, utteranceEndData } = state;
```

### Issue 2: Missing VAD Events

**Problem:** Not receiving VAD events.

**Solution:**
```typescript
// Ensure VAD events are properly configured
<DeepgramVoiceInteraction
  onUserStoppedSpeaking={() => console.log('User stopped')}
  onUtteranceEnd={(data) => console.log('Utterance ended:', data)}
  onVADEvent={(event) => console.log('VAD event:', event)}
/>
```

### Issue 3: Connection Issues

**Problem:** Connection problems after migration.

**Solution:**
```typescript
// Check connection state and implement lazy reconnection
const { connections } = state;

if (connections.agent === 'disconnected') {
  // Use lazy reconnection
  await deepgramRef.current?.resumeWithText('Hello');
}
```

### Issue 4: State Update Issues

**Problem:** State not updating properly.

**Solution:**
```typescript
// Ensure state callback is properly implemented
const handleStateChange = (newState: VoiceInteractionState) => {
  setState(newState);
  
  // React to specific state changes
  if (newState.isUserSpeaking && !state?.isUserSpeaking) {
    console.log('User started speaking');
  }
};
```

## Testing Your Migration

### Unit Tests
```typescript
// Test new state properties
expect(state.isUserSpeaking).toBeDefined();
expect(state.utteranceEndData).toBeDefined();

// Test new callbacks
const mockOnUserStoppedSpeaking = jest.fn();
const mockOnUtteranceEnd = jest.fn();

// Test callback invocation
expect(mockOnUserStoppedSpeaking).toHaveBeenCalled();
expect(mockOnUtteranceEnd).toHaveBeenCalledWith(expect.any(Object));
```

### Integration Tests
```typescript
// Test VAD events
await waitFor(() => {
  expect(onUserStoppedSpeaking).toHaveBeenCalled();
});

// Test lazy reconnection
await deepgramRef.current?.resumeWithText('Test message');
expect(connections.agent).toBe('connected');
```

### E2E Tests
```typescript
// Test VAD events in browser
await page.waitForSelector('[data-testid="user-stopped-speaking"]');

// Test lazy reconnection
await page.click('[data-testid="resume-text-button"]');
await page.waitForSelector('[data-testid="connection-status"]:has-text("connected")');
```

## Rollback Plan

If you encounter issues after migration:

### Step 1: Immediate Rollback
```bash
npm install deepgram-voice-interaction-react@^0.x
```

### Step 2: Remove New Features
Remove any new VAD event handling code:
```typescript
// Remove these if causing issues
onUserStoppedSpeaking={...}
onUtteranceEnd={...}
onVADEvent={...}
onStateChange={...}
```

### Step 3: Revert State Usage
Revert to using only the original state properties:
```typescript
// Use only original properties
const { isReady, agentState, isRecording } = state;
```

## Migration Examples

### Example 1: Basic Chat Application

#### Before (v0.x)
```typescript
const BasicChat = () => {
  const [messages, setMessages] = useState([]);
  
  return (
    <DeepgramVoiceInteraction
      apiKey="your-api-key"
      agentOptions={{
        language: 'en',
        voice: 'aura-asteria-en',
        instructions: 'You are a helpful assistant.'
      }}
      onUserStartedSpeaking={() => console.log('User started')}
      onAgentResponse={(response) => {
        setMessages(prev => [...prev, { role: 'assistant', content: response }]);
      }}
    />
  );
};
```

#### After (v1.0.0)
```typescript
const BasicChat = () => {
  const [messages, setMessages] = useState([]);
  const [state, setState] = useState(null);
  
  return (
    <DeepgramVoiceInteraction
      apiKey="your-api-key"
      agentOptions={{
        language: 'en',
        voice: 'aura-asteria-en',
        instructions: 'You are a helpful assistant.',
        utteranceEndMs: 2000,  // NEW: VAD configuration
        vadThreshold: 0.7       // NEW: VAD sensitivity
      }}
      onUserStartedSpeaking={() => console.log('User started')}
      onUserStoppedSpeaking={() => console.log('User stopped')}  // NEW: VAD callback
      onUtteranceEnd={(data) => console.log('Utterance ended:', data)}  // NEW: VAD callback
      onStateChange={setState}  // NEW: State management
      onAgentResponse={(response) => {
        setMessages(prev => [...prev, { role: 'assistant', content: response }]);
      }}
    />
  );
};
```

### Example 2: Advanced Voice Assistant

#### Before (v0.x)
```typescript
const VoiceAssistant = () => {
  const [isReady, setIsReady] = useState(false);
  
  return (
    <DeepgramVoiceInteraction
      apiKey="your-api-key"
      agentOptions={{
        language: 'en',
        voice: 'aura-asteria-en',
        instructions: 'You are a helpful assistant.'
      }}
      onUserStartedSpeaking={() => console.log('User started')}
      onAgentResponse={(response) => console.log('Agent:', response)}
    />
  );
};
```

#### After (v1.0.0)
```typescript
const VoiceAssistant = () => {
  const [state, setState] = useState(null);
  const [speechStats, setSpeechStats] = useState({
    totalSpeakingTime: 0,
    utteranceCount: 0
  });
  
  const handleUtteranceEnd = (data: UtteranceEndData) => {
    setSpeechStats(prev => ({
      totalSpeakingTime: prev.totalSpeakingTime + data.duration,
      utteranceCount: prev.utteranceCount + 1
    }));
  };
  
  return (
    <DeepgramVoiceInteraction
      apiKey="your-api-key"
      agentOptions={{
        language: 'en',
        voice: 'aura-asteria-en',
        instructions: 'You are a helpful assistant.',
        utteranceEndMs: 2000,
        vadThreshold: 0.7
      }}
      onUserStartedSpeaking={() => console.log('User started')}
      onUserStoppedSpeaking={() => console.log('User stopped')}
      onUtteranceEnd={handleUtteranceEnd}
      onVADEvent={(event) => console.log('VAD event:', event)}
      onStateChange={setState}
      onAgentResponse={(response) => console.log('Agent:', response)}
    />
  );
};
```

## Support

### Getting Help
- **GitHub Issues**: Create an issue for migration questions
- **Documentation**: Check [NEW-FEATURES.md](./NEW-FEATURES.md) for detailed feature docs
- **Examples**: Review [EXAMPLES.md](./EXAMPLES.md) for usage patterns

### Reporting Issues
When reporting migration issues:
1. Include version information (from/to)
2. Provide complete error messages
3. Include relevant code examples
4. Describe steps taken before the issue

## Migration Checklist

- [ ] **Dependencies Updated**: Installed v1.0.0
- [ ] **Breaking Changes Reviewed**: Checked state interface and callbacks
- [ ] **New Features Added**: Implemented VAD events (optional)
- [ ] **Tests Updated**: Updated tests for new features
- [ ] **Migration Tested**: Tested in development environment
- [ ] **Staging Deployed**: Deployed and tested in staging
- [ ] **Production Deployed**: Deployed to production
- [ ] **Monitoring Active**: Monitoring for issues

## Next Steps

After successful migration:
1. **Explore New Features**: Utilize VAD events and lazy reconnection
2. **Optimize Performance**: Take advantage of performance improvements
3. **Enhance UX**: Use enhanced state management for better user experience
4. **Stay Updated**: Follow future releases for additional features

---

**Related Documentation:**
- [NEW-FEATURES.md](./NEW-FEATURES.md) - Detailed feature documentation
- [API-CHANGES.md](./API-CHANGES.md) - Complete API surface changes
- [EXAMPLES.md](./EXAMPLES.md) - Usage examples and patterns
