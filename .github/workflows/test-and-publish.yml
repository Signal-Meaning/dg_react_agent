name: Test and Publish Package

on:
  push:
    branches: [ main, 'release/v*' ]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      test_only:
        description: 'Run only test-jest (skip publish). Use this to validate workflow/action changes without publishing.'
        required: false
        type: boolean
        default: false
      version:
        description: 'Version to publish (leave empty to use package.json version)'
        required: false
        type: string
        default: ''
      branch:
        description: 'Branch to publish from (leave empty to use current branch). Note: GitHub UI branch selector order cannot be customized.'
        required: false
        type: string
        default: ''
      force:
        description: 'Force publish even if version already exists (use with caution)'
        required: false
        type: boolean
        default: false

jobs:
  test-jest:
    name: Jest Tests (Unit & Integration)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}
      
      - name: Prelim (Node, install, build)
        uses: Signal-Meaning/dg_react_agent/.github/actions/prelim@main
        with:
          ref: ${{ inputs.branch || github.ref }}
        
      - name: Run linting
        run: npm run lint
        
      - name: Run Jest tests (mock only)
        run: npm run test:mock
        env:
          CI: true
          RUN_REAL_API_TESTS: false
          NODE_ENV: test
        
      - name: Test package packaging
        run: |
          # Test that the package can be packaged for local use
          npm run package:local
          
          # Verify the package was created
          ls -la *.tgz
          
      - name: Test package installation from tarball
        run: |
          # Create a temporary directory to test package installation
          mkdir test-install
          cd test-install
          
          # Create a test package.json
          echo '{"name": "test-install", "version": "1.0.0", "dependencies": {}}' > package.json
          
          # Install from the local tarball
          npm install ../*.tgz
          
          # Verify the package was installed
          ls node_modules/@signal-meaning/deepgram-voice-interaction-react
          
          # Test that the package can be imported
          node -e "console.log('Testing import...'); const pkg = require('@signal-meaning/deepgram-voice-interaction-react'); console.log('Package imported successfully:', Object.keys(pkg));"
          
          # Clean up
          cd ..
          rm -rf test-install

      - name: Validate voice-agent-backend package (pack dry-run)
        run: |
          cd packages/voice-agent-backend
          npm pack --dry-run

  # E2E tests temporarily disabled in CI
  # test-e2e:
  #   name: Playwright E2E Tests
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         ref: ${{ inputs.branch || github.ref }}
  #     
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         
  #     - name: Install dependencies
  #       run: npm ci
  #       
  #     - name: Build package
  #       run: npm run build
  #       
  #     - name: Install test-app dependencies
  #       run: |
  #         cd test-app
  #         npm ci
  #       
  #     - name: Install Playwright browsers (Chromium only)
  #       run: |
  #         cd test-app
  #         npx playwright install chromium --with-deps
  #     
  #     - name: Verify test-app can start dev server
  #       run: |
  #         cd test-app
  #         timeout 30 npm run dev &
  #         sleep 10
  #         curl -f http://localhost:5173 || (echo "âŒ Dev server failed to start" && exit 1)
  #         pkill -f "vite" || true
  #         echo "âœ… Dev server starts successfully"
  #       
  #     - name: Run Playwright E2E tests (CI-safe only)
  #       run: |
  #         cd test-app
  #         # Run only CI-safe E2E tests (core functionality without audio/microphone dependencies)
  #         # Use --config to ensure webServer config is loaded
  #         npx playwright test --config=tests/playwright.config.mjs \
  #           tests/e2e/api-key-validation.spec.js \
  #           tests/e2e/text-only-conversation.spec.js \
  #           tests/e2e/lazy-initialization-e2e.spec.js \
  #           tests/e2e/page-content.spec.js \
  #           tests/e2e/deepgram-ux-protocol.spec.js \
  #           tests/e2e/protocol-validation-modes.spec.js
  #       env:
  #         CI: true
  #         VITE_DEEPGRAM_API_KEY: ${{ secrets.VITE_DEEPGRAM_API_KEY }}
  #         VITE_DEEPGRAM_PROJECT_ID: ${{ secrets.VITE_DEEPGRAM_PROJECT_ID }}
  #         VITE_BASE_URL: 'http://localhost:5173'

  publish:
    name: Publish Package
    runs-on: ubuntu-latest
    needs: [test-jest] # test-e2e temporarily disabled
    if: success() && (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.test_only != true) || (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/v')))
    permissions:
      contents: write   # read + write for creating release tag and GitHub Release
      packages: write
      id-token: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}
      
      - name: Prelim (Node, install, build)
        uses: Signal-Meaning/dg_react_agent/.github/actions/prelim@main
        with:
          ref: ${{ inputs.branch || github.ref }}
          registry-url: 'https://npm.pkg.github.com'
          scope: '@signal-meaning'
          token: ${{ secrets.NPM_TOKEN }}
      
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸŒ¿ Branch: $BRANCH_NAME"
      
      - name: Verify npm configuration
        run: |
          # setup-node@v4 automatically configures authentication
          # We just verify the registry is set correctly
          echo "ðŸ“‹ Verifying npm configuration..."
          echo "Default registry: $(npm config get registry)"
          echo "Scope registry: $(npm config get @signal-meaning:registry)"
          
          # Verify .npmrc exists (location set by setup-node@v4)
          if [ -n "$NPM_CONFIG_USERCONFIG" ]; then
            if [ -f "$NPM_CONFIG_USERCONFIG" ]; then
              echo "âœ… npmrc configuration file exists at: $NPM_CONFIG_USERCONFIG"
              echo "ðŸ“„ npmrc content (first few lines, masked):"
              head -3 "$NPM_CONFIG_USERCONFIG" | sed 's/_authToken=.*/_authToken=***MASKED***/' || true
            else
              echo "âš ï¸ npmrc file not found at expected location: $NPM_CONFIG_USERCONFIG"
              echo "ðŸ”§ Attempting to create .npmrc manually as fallback..."
              echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
              echo "@signal-meaning:registry=https://npm.pkg.github.com" >> ~/.npmrc
              echo "âœ… Created ~/.npmrc as fallback"
            fi
          else
            echo "âš ï¸ NPM_CONFIG_USERCONFIG not set, creating .npmrc manually..."
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "@signal-meaning:registry=https://npm.pkg.github.com" >> ~/.npmrc
            echo "âœ… Created ~/.npmrc"
          fi
          
          # Also ensure project-level .npmrc exists (for compatibility)
          if [ ! -f .npmrc ]; then
            echo "@signal-meaning:registry=https://npm.pkg.github.com" > .npmrc
            echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc
            echo "âœ… Created project-level .npmrc"
          fi
        
      - name: Verify authentication
        run: |
          echo "ðŸ” Verifying authentication..."
          npm whoami --registry https://npm.pkg.github.com || {
            echo "âŒ Authentication verification failed"
            echo ""
            echo "Common causes:"
            echo "  1. NPM_TOKEN secret missing or invalid"
            echo "  2. Token lacks 'write:packages' permission"
            echo "  3. Token lacks access to @signal-meaning organization"
            echo "  4. Token expired"
            echo ""
            echo "Check repository settings:"
            echo "  - Secrets > NPM_TOKEN exists"
            echo "  - Token has write:packages scope"
            echo "  - Token has organization access"
            exit 1
          }
          echo "âœ… Authentication verified"
          
      - name: Check if version already exists
        id: check_version
        run: |
          CHECK_VERSION="${{ steps.version.outputs.version }}"
          if npm view @signal-meaning/deepgram-voice-interaction-react@$CHECK_VERSION --registry https://npm.pkg.github.com 2>/dev/null; then
            echo "version_exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Version $CHECK_VERSION already exists in registry"
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Version $CHECK_VERSION does not exist, ready to publish"
          fi
        continue-on-error: true

      - name: Determine voice-agent-backend version
        id: backend_version
        run: |
          BACKEND_VERSION=$(node -p "require('./packages/voice-agent-backend/package.json').version")
          echo "version=$BACKEND_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ voice-agent-backend version: $BACKEND_VERSION"

      - name: Check if voice-agent-backend version already exists
        id: check_backend_version
        run: |
          CHECK_VERSION="${{ steps.backend_version.outputs.version }}"
          if npm view @signal-meaning/voice-agent-backend@$CHECK_VERSION --registry https://npm.pkg.github.com 2>/dev/null; then
            echo "version_exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ voice-agent-backend@$CHECK_VERSION already exists in registry"
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "âœ… voice-agent-backend@$CHECK_VERSION does not exist, ready to publish"
          fi
        continue-on-error: true
        
      - name: Publish to GitHub Package Registry
        run: |
          set -e
          # Use version from earlier step
          PUBLISH_VERSION="${{ steps.version.outputs.version }}"
          FORCE_PUBLISH="${{ inputs.force }}"
          
          # If version already exists and force is not enabled: warn, skip publish, continue (so release step can run)
          if [ "${{ steps.check_version.outputs.version_exists }}" == "true" ] && [ "$FORCE_PUBLISH" != "true" ]; then
            echo "âš ï¸ Version $PUBLISH_VERSION already exists in registry"
            echo "âš ï¸ Skipping publish; continuing so Create GitHub Release can run."
            echo "ðŸ’¡ To overwrite, set 'force' input to 'true' (use with caution)"
            exit 0
          fi
          
          if [ "${{ steps.check_version.outputs.version_exists }}" == "true" ] && [ "$FORCE_PUBLISH" == "true" ]; then
            echo "âš ï¸ Version $PUBLISH_VERSION already exists, but force=true - proceeding with publish"
          fi
          
          # Show npm configuration before publish
          echo "ðŸ“¦ Package name: $(node -p "require('./package.json').name")"
          echo "ðŸ“¦ Publishing version: $PUBLISH_VERSION"
          echo "ðŸ“¦ Package.json version: $(node -p "require('./package.json').version")"
          echo "ðŸ“¦ Registry: $(npm config get registry)"
          echo "ðŸ“¦ Scope registry: $(npm config get @signal-meaning:registry)"
          
          # Verify version matches package.json (unless explicitly overridden)
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if [ "$PUBLISH_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âš ï¸ Warning: Publishing version ($PUBLISH_VERSION) differs from package.json ($PACKAGE_VERSION)"
            echo "âš ï¸ This may cause version mismatch issues"
          fi
          
          # Show what will be published
          echo "ðŸ“‹ Files to be published:"
          npm pack --dry-run 2>/dev/null | tail -20 || true
          
          # Attempt publish with detailed error capture
          npm publish 2>&1 | tee /tmp/npm-publish-output.log || {
            EXIT_CODE=${PIPESTATUS[0]}
            echo ""
            echo "âŒ Publish failed with exit code: $EXIT_CODE"
            echo ""
            echo "ðŸ“‹ npm publish output:"
            cat /tmp/npm-publish-output.log || echo "No output captured"
            echo ""
            echo "ðŸ“‹ npm debug logs (most recent):"
            find ~/.npm/_logs -name "*debug*.log" -type f -mtime -1 2>/dev/null | head -1 | xargs cat 2>/dev/null || {
              echo "Listing all debug logs:"
              ls -la ~/.npm/_logs/*debug*.log 2>/dev/null || echo "No debug logs found"
              # Try to cat the most recent one
              ls -t ~/.npm/_logs/*debug*.log 2>/dev/null | head -1 | xargs cat 2>/dev/null || echo "Could not read debug log"
            }
            echo ""
            echo "Common causes:"
            echo "  - Version already exists (409 Conflict)"
            echo "  - Authentication failed (401 Unauthorized)"
            echo "  - Insufficient permissions (403 Forbidden)"
            echo "  - Missing files or invalid package.json"
            echo "  - prepublishOnly script failed"
            exit $EXIT_CODE
          }
          echo "âœ… Package published successfully"
          
      - name: Publish voice-agent-backend to GitHub Package Registry
        run: |
          set -e
          FORCE_PUBLISH="${{ inputs.force }}"
          BACKEND_VERSION="${{ steps.backend_version.outputs.version }}"
          
          if [ "${{ steps.check_backend_version.outputs.version_exists }}" == "true" ] && [ "$FORCE_PUBLISH" != "true" ]; then
            echo "âš ï¸ voice-agent-backend@$BACKEND_VERSION already exists in registry"
            echo "âš ï¸ Skipping publish (set force to overwrite)."
            exit 0
          fi
          
          cd packages/voice-agent-backend
          echo "ðŸ“¦ Publishing @signal-meaning/voice-agent-backend@$BACKEND_VERSION"
          npm pack --dry-run 2>/dev/null | tail -15 || true
          npm publish 2>&1 | tee /tmp/npm-publish-backend.log || {
            EXIT_CODE=${PIPESTATUS[0]}
            echo "âŒ voice-agent-backend publish failed with exit code: $EXIT_CODE"
            cat /tmp/npm-publish-backend.log
            exit $EXIT_CODE
          }
          echo "âœ… voice-agent-backend published successfully"
          
      - name: Verify package installation
        run: |
          # Create a temporary directory to test package installation
          mkdir test-install
          cd test-install
          
          # Create a test package.json
          echo '{"name": "test-install", "version": "1.0.0", "dependencies": {}}' > package.json
          
          # Configure npm for GitHub Package Registry
          echo "@signal-meaning:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc
          
          # Install the package
          npm install @signal-meaning/deepgram-voice-interaction-react
          
          # Verify the package was installed
          ls node_modules/@signal-meaning/deepgram-voice-interaction-react
          
          # Clean up
          cd ..
          rm -rf test-install

      - name: Verify voice-agent-backend installation
        run: |
          mkdir test-install-backend
          cd test-install-backend
          echo '{"name": "test-install-backend", "version": "1.0.0", "dependencies": {}}' > package.json
          echo "@signal-meaning:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc
          npm install @signal-meaning/voice-agent-backend
          ls node_modules/@signal-meaning/voice-agent-backend
          node -e "const pkg = require('@signal-meaning/voice-agent-backend'); console.log('voice-agent-backend imported:', Object.keys(pkg));"
          cd ..
          rm -rf test-install-backend

      # Create GitHub Release (and tag) when triggered by push to release/v* or workflow_dispatch (not when trigger is release:published)
      - name: Create GitHub Release
        if: success() && (github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/v')))
        run: |
          VER="v${{ steps.version.outputs.version }}"
          if gh release view "$VER" --repo $GITHUB_REPOSITORY 2>/dev/null; then
            echo "Release $VER already exists, skipping."
            exit 0
          fi
          NOTES="docs/releases/$VER/RELEASE-NOTES.md"
          if [ -f "$NOTES" ]; then
            gh release create "$VER" --title "$VER" --notes-file "$NOTES" --repo $GITHUB_REPOSITORY
          else
            gh release create "$VER" --title "$VER" --notes "Release $VER" --repo $GITHUB_REPOSITORY
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
