name: Test and Publish Package

on:
  push:
    branches: [ main ]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty to use package.json version)'
        required: false
        type: string
        default: ''
      branch:
        description: 'Branch to publish from (leave empty to use current branch). Note: GitHub UI branch selector order cannot be customized.'
        required: false
        type: string
        default: ''

jobs:
  test-jest:
    name: Jest Tests (Unit & Integration)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run linting
        run: npm run lint
        
      - name: Build package
        run: npm run build
        
      - name: Run Jest tests (mock only)
        run: npm run test:mock
        env:
          CI: true
          RUN_REAL_API_TESTS: false
          NODE_ENV: test
        
      - name: Test package packaging
        run: |
          # Test that the package can be packaged for local use
          npm run package:local
          
          # Verify the package was created
          ls -la *.tgz
          
      - name: Test package installation from tarball
        run: |
          # Create a temporary directory to test package installation
          mkdir test-install
          cd test-install
          
          # Create a test package.json
          echo '{"name": "test-install", "version": "1.0.0", "dependencies": {}}' > package.json
          
          # Install from the local tarball
          npm install ../*.tgz
          
          # Verify the package was installed
          ls node_modules/@signal-meaning/deepgram-voice-interaction-react
          
          # Test that the package can be imported
          node -e "console.log('Testing import...'); const pkg = require('@signal-meaning/deepgram-voice-interaction-react'); console.log('Package imported successfully:', Object.keys(pkg));"
          
          # Clean up
          cd ..
          rm -rf test-install

  test-e2e:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build package
        run: npm run build
        
      - name: Install test-app dependencies
        run: |
          cd test-app
          npm ci
        
      - name: Install Playwright browsers
        run: |
          cd test-app
          npx playwright install --with-deps chromium
        
      - name: Run Playwright E2E tests
        run: |
          cd test-app
          npm run test:e2e
        env:
          CI: true
          VITE_DEEPGRAM_API_KEY: ${{ secrets.VITE_DEEPGRAM_API_KEY }}
          VITE_DEEPGRAM_PROJECT_ID: ${{ secrets.VITE_DEEPGRAM_PROJECT_ID }}
          VITE_BASE_URL: 'http://localhost:5173'

  publish:
    name: Publish Package
    runs-on: ubuntu-latest
    needs: [test-jest, test-e2e]
    if: success() && (github.event_name == 'release' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      packages: write
      id-token: write
      
    steps:
      - name: Determine version and branch
        id: vars
        run: |
          # For workflow_dispatch, we need to checkout first to read package.json
          # But we'll use the branch input if provided
          echo "version=placeholder" >> $GITHUB_OUTPUT
          echo "branch=${{ inputs.branch || 'placeholder' }}" >> $GITHUB_OUTPUT
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}
      
      - name: Determine version (after checkout)
        id: version
        run: |
          # Determine version - use input if provided, otherwise read from package.json
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          
          # Determine branch name for display
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸŒ¿ Branch: $BRANCH_NAME"
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@signal-meaning'
          token: ${{ secrets.NPM_PACKAGES_TOKEN }}
          always-auth: true
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build package
        run: npm run build
        
      - name: Verify npm configuration
        run: |
          # setup-node@v4 automatically configures authentication
          # We just verify the registry is set correctly
          echo "ðŸ“‹ Verifying npm configuration..."
          echo "Default registry: $(npm config get registry)"
          echo "Scope registry: $(npm config get @signal-meaning:registry)"
          
          # Verify .npmrc exists (location set by setup-node@v4)
          if [ -n "$NPM_CONFIG_USERCONFIG" ]; then
            if [ -f "$NPM_CONFIG_USERCONFIG" ]; then
              echo "âœ… npmrc configuration file exists at: $NPM_CONFIG_USERCONFIG"
              echo "ðŸ“„ npmrc content (first few lines, masked):"
              head -3 "$NPM_CONFIG_USERCONFIG" | sed 's/_authToken=.*/_authToken=***MASKED***/' || true
            else
              echo "âš ï¸ npmrc file not found at expected location: $NPM_CONFIG_USERCONFIG"
              echo "ðŸ”§ Attempting to create .npmrc manually as fallback..."
              echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_PACKAGES_TOKEN }}" > ~/.npmrc
              echo "@signal-meaning:registry=https://npm.pkg.github.com" >> ~/.npmrc
              echo "âœ… Created ~/.npmrc as fallback"
            fi
          else
            echo "âš ï¸ NPM_CONFIG_USERCONFIG not set, creating .npmrc manually..."
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_PACKAGES_TOKEN }}" > ~/.npmrc
          echo "@signal-meaning:registry=https://npm.pkg.github.com" >> ~/.npmrc
            echo "âœ… Created ~/.npmrc"
          fi
          
          # Also ensure project-level .npmrc exists (for compatibility)
          if [ ! -f .npmrc ]; then
            echo "@signal-meaning:registry=https://npm.pkg.github.com" > .npmrc
            echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_PACKAGES_TOKEN }}" >> .npmrc
            echo "âœ… Created project-level .npmrc"
          fi
        
      - name: Verify authentication
        run: |
          echo "ðŸ” Verifying authentication..."
          npm whoami --registry https://npm.pkg.github.com || {
            echo "âŒ Authentication verification failed"
            echo ""
            echo "Common causes:"
            echo "  1. NPM_PACKAGES_TOKEN secret missing or invalid"
            echo "  2. Token lacks 'write:packages' permission"
            echo "  3. Token lacks access to @signal-meaning organization"
            echo "  4. Token expired"
            echo ""
            echo "Check repository settings:"
            echo "  - Secrets > NPM_PACKAGES_TOKEN exists"
            echo "  - Token has write:packages scope"
            echo "  - Token has organization access"
            exit 1
          }
          echo "âœ… Authentication verified"
          
      - name: Check if version already exists
        id: check_version
        run: |
          CHECK_VERSION="${{ steps.version.outputs.version }}"
          if npm view @signal-meaning/deepgram-voice-interaction-react@$CHECK_VERSION --registry https://npm.pkg.github.com 2>/dev/null; then
            echo "version_exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Version $CHECK_VERSION already exists in registry"
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Version $CHECK_VERSION does not exist, ready to publish"
          fi
        continue-on-error: true
        
      - name: Publish to GitHub Package Registry
        run: |
          set -e
          # Use version from earlier step
          PUBLISH_VERSION="${{ steps.version.outputs.version }}"
          
          # Show npm configuration before publish
          echo "ðŸ“¦ Package name: $(node -p "require('./package.json').name")"
          echo "ðŸ“¦ Publishing version: $PUBLISH_VERSION"
          echo "ðŸ“¦ Package.json version: $(node -p "require('./package.json').version")"
          echo "ðŸ“¦ Registry: $(npm config get registry)"
          echo "ðŸ“¦ Scope registry: $(npm config get @signal-meaning:registry)"
          
          # Verify version matches package.json (unless explicitly overridden)
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if [ "$PUBLISH_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âš ï¸ Warning: Publishing version ($PUBLISH_VERSION) differs from package.json ($PACKAGE_VERSION)"
            echo "âš ï¸ This may cause version mismatch issues"
          fi
          
          # Show what will be published
          echo "ðŸ“‹ Files to be published:"
          npm pack --dry-run 2>/dev/null | tail -20 || true
          
          # Attempt publish with detailed error capture
          npm publish 2>&1 | tee /tmp/npm-publish-output.log || {
            EXIT_CODE=${PIPESTATUS[0]}
            echo ""
            echo "âŒ Publish failed with exit code: $EXIT_CODE"
            echo ""
            echo "ðŸ“‹ npm publish output:"
            cat /tmp/npm-publish-output.log || echo "No output captured"
            echo ""
            echo "ðŸ“‹ npm debug logs (most recent):"
            find ~/.npm/_logs -name "*debug*.log" -type f -mtime -1 2>/dev/null | head -1 | xargs cat 2>/dev/null || {
              echo "Listing all debug logs:"
              ls -la ~/.npm/_logs/*debug*.log 2>/dev/null || echo "No debug logs found"
              # Try to cat the most recent one
              ls -t ~/.npm/_logs/*debug*.log 2>/dev/null | head -1 | xargs cat 2>/dev/null || echo "Could not read debug log"
            }
            echo ""
            echo "Common causes:"
            echo "  - Version already exists (409 Conflict)"
            echo "  - Authentication failed (401 Unauthorized)"
            echo "  - Insufficient permissions (403 Forbidden)"
            echo "  - Missing files or invalid package.json"
            echo "  - prepublishOnly script failed"
            exit $EXIT_CODE
          }
          echo "âœ… Package published successfully"
          
      - name: Verify package installation
        run: |
          # Create a temporary directory to test package installation
          mkdir test-install
          cd test-install
          
          # Create a test package.json
          echo '{"name": "test-install", "version": "1.0.0", "dependencies": {}}' > package.json
          
          # Configure npm for GitHub Package Registry
          echo "@signal-meaning:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_PACKAGES_TOKEN }}" >> .npmrc
          
          # Install the package
          npm install @signal-meaning/deepgram-voice-interaction-react
          
          # Verify the package was installed
          ls node_modules/@signal-meaning/deepgram-voice-interaction-react
          
          # Clean up
          cd ..
          rm -rf test-install
