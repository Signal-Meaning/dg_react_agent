name: Debug Authentication

on:
  workflow_dispatch:
    inputs:
      debug_token:
        description: 'Debug token (optional)'
        required: false
        type: string

jobs:
  debug:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@signal-meaning'
          token: ${{ secrets.NPM_TOKEN }}
          
      - name: Debug Environment
        run: |
          echo "=== Environment Debug ==="
          echo "NODE_AUTH_TOKEN length: ${#NODE_AUTH_TOKEN}"
          echo "NODE_AUTH_TOKEN starts with: ${NODE_AUTH_TOKEN:0:10}..."
          echo "NODE_AUTH_TOKEN ends with: ...${NODE_AUTH_TOKEN: -10}"
          echo ""
          echo "=== NPM Configuration ==="
          npm config list
          echo ""
          echo "=== Registry Ping Test ==="
          if ! npm ping --registry https://npm.pkg.github.com; then
            echo "❌ Registry ping failed"
            exit 1
          fi
          echo "✅ Registry ping successful"
          echo ""
          echo "=== Authentication Test ==="
          if ! npm whoami --registry https://npm.pkg.github.com; then
            echo "❌ Authentication failed"
            exit 1
          fi
          echo "✅ Authentication successful"
          echo ""
          echo "=== Package Access Test ==="
          if ! npm view @signal-meaning/deepgram-voice-interaction-react --registry https://npm.pkg.github.com; then
            echo "❌ Package view failed"
            exit 1
          fi
          echo "✅ Package view successful"
          echo ""
          echo "=== Manual .npmrc Test ==="
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "@signal-meaning:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "Manual .npmrc content:"
          cat ~/.npmrc
          echo ""
          echo "Testing with manual .npmrc:"
          if ! npm whoami --registry https://npm.pkg.github.com; then
            echo "❌ Manual authentication failed"
            exit 1
          fi
          echo "✅ Manual authentication successful"
          echo ""
          echo "=== Testing actual publish (dry run) ==="
          if ! npm publish --dry-run; then
            echo "❌ Dry run publish failed"
            exit 1
          fi
          echo "✅ Dry run publish successful"
