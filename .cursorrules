# Cursor Rules for dg_react_agent

## Project Objectives

**Fork Purpose:** This fork of `dg_react_agent` adds `test-app` as a demonstration of a React web testable frontend to the dg_react_agent React component.

**API Compatibility Requirement:** The component MUST maintain API compatibility with the Deepgram Voice Agent API:
- Voice Agent API v1: https://developers.deepgram.com/docs/voice-agent
- Migration Guide: https://developers.deepgram.com/docs/voice-agent-v1-migration

Any improvements must be justified and maintain compatibility with the Voice Agent API.

**Test App Goals:** The test-app and its related tests are intended to:
- Recommend certain integration patterns and avoid others
- Act as a starting point for React developers
- Demonstrate proper usage of the headless dg_react_agent component
- MUST maintain API compatibility with the headless dg_react_agent component

## ‚ö†Ô∏è CRITICAL: Test-Driven Development (TDD)

**THIS PROJECT USES TEST-DRIVEN DEVELOPMENT. TESTS ALWAYS COME FIRST.**

### TDD Workflow (MANDATORY)

1. **üî¥ RED**: Write failing tests FIRST that define expected behavior
2. **üü¢ GREEN**: Implement minimal code to make tests pass
3. **‚ôªÔ∏è REFACTOR**: Improve code quality while keeping tests green
4. **üîÑ REPEAT**: Continue cycle for each feature increment

### TDD Rules

- **NEVER write implementation code without tests first**
- **NEVER skip writing tests** - tests are not optional
- **ALWAYS write tests before implementation** - this is non-negotiable
- **Tests define requirements** - tests serve as executable specifications
- **Red-Green-Refactor cycle** - follow this cycle for all development

### When Starting Any Feature or Bug Fix

1. **First**: Write failing tests that describe the desired behavior
2. **Second**: Run tests to confirm they fail (RED)
3. **Third**: Write minimal implementation to make tests pass (GREEN)
4. **Fourth**: Refactor code while keeping tests passing (REFACTOR)

### Test Requirements

- **Unit Tests**: Required for all component logic, utilities, and services
- **Integration Tests**: Required for WebSocket, audio, and cross-service interactions
- **E2E Tests**: Required for user-facing features and critical workflows
- **Test Coverage**: Maintain high coverage (>90% for critical paths)

### Test File Organization

- **Unit Tests**: `tests/` directory (Jest)
- **E2E Tests**: `test-app/tests/e2e/` directory (Playwright)
- **Test Utilities**: `tests/utils/` and `test-app/tests/helpers/`
- **Test Fixtures**: `tests/fixtures/` and `test-app/tests/fixtures/`

### Testing Standards

- **Test Naming**: Descriptive test names that explain what is being tested
- **Test Structure**: Arrange-Act-Assert pattern
- **Test Isolation**: Each test should be independent and not rely on other tests
- **Mock vs Real**: Prefer real API testing for integration, use mocks for unit tests
- **Test Documentation**: Tests should be self-documenting through clear naming

## Development Guidelines

### Fork Point
- Pre-fork: commit `7191eb4a062f35344896e873f02eba69c9c46a2d`
- Post-fork: all development after that point

### Voice Agent API Only
- The component uses ONLY the Deepgram Voice Agent API
- No Transcription API features should be used
- All `SpeechStarted` references in documentation/types should be removed or marked as deprecated

## Voice Agent API v1 Endpoint
- **CRITICAL**: Component uses Voice Agent v1 API endpoint
- ‚úÖ Correct endpoint: `wss://agent.deepgram.com/v1/agent/converse`
- ‚ùå NOT: `wss://agent.deepgram.com/agent` (deprecated early access)
- **Verification**: Check `src/types/connection.ts` line 27
- **API Specs**: https://github.com/deepgram/deepgram-api-specs

## Microphone Functionality
- **Preserve:** `startAudioCapture()` method (was present pre-fork)
- **Be cautious with:** `toggleMic()` and `microphoneEnabled` prop (added post-fork, may cause connection issues)
- **Test app expects:** `startAudioCapture()` method to be available via ref

## Component Architecture
- The component should be headless (no UI elements)
- Microphone control should primarily be handled by the test app, not the component
- The component should focus on WebSocket management and audio processing

## Testing Guidelines

### üìö Test Documentation

**ALWAYS consult the test documentation before writing or running tests:**

- **[E2E Test README](test-app/tests/e2e/README.md)**: Complete guide to E2E testing with real Deepgram API
  - Setup instructions and environment configuration
  - **Full Test Pass Guidelines**: How to run full test suites with file output and monitoring
  - Available test files and their purposes
  - Troubleshooting common issues

- **[E2E Test Development Guide](test-app/tests/e2e/E2E_TEST_DEVELOPMENT_GUIDE.md)**: Comprehensive guide for writing E2E tests
  - Available fixtures and their usage
  - Best practices and common patterns
  - Common pitfalls to avoid
  - Migration examples and test structure guidelines
  - **Full Test Pass Guidelines**: Required practices for running comprehensive test suites

- **[Testing Quick Start](docs/TESTING-QUICK-START.md)**: Quick reference for testing voice features
  - Basic voice interaction test examples
  - Available audio samples
  - Common pitfalls and solutions

- **[Test Utilities](docs/TEST-UTILITIES.md)**: Complete testing infrastructure guide
  - Available test utilities and helpers
  - Mock vs real API testing strategies
  - Test data and fixtures

### Test Types and When to Use Them

#### Unit Tests (Jest) - `tests/` directory
- **Purpose**: Test component logic, utilities, and services in isolation
- **When**: Testing individual functions, methods, or component behavior
- **Tools**: Jest, React Testing Library, mocks
- **Example**: Testing that functions are included in Settings message

#### Integration Tests (Jest) - `tests/` directory
- **Purpose**: Test interactions between components, services, and WebSocket
- **When**: Testing cross-service interactions, WebSocket message handling
- **Tools**: Jest, mocks for WebSocketManager and AudioManager
- **Example**: Testing Settings message sending and receiving

#### E2E Tests (Playwright) - `test-app/tests/e2e/` directory
- **Purpose**: Test complete user workflows with real API connections
- **When**: Testing full user flows, real API integration, critical paths
- **Tools**: Playwright, real Deepgram API (when available)
- **Example**: Testing full function calling flow from connection to execution
- **‚ö†Ô∏è IMPORTANT**: See [E2E Test README](test-app/tests/e2e/README.md) for full test pass guidelines

### Test Utilities

- **MicrophoneHelpers**: Use for consistent microphone testing in E2E tests
- **Component Test Helpers**: `tests/utils/component-test-helpers.tsx` for component setup
- **WebSocket Capture**: Use `installWebSocketCapture()` for E2E WebSocket inspection
- **Audio Helpers**: `test-app/tests/e2e/fixtures/audio-helpers.js` for audio testing

### Testing Best Practices

- **Real API First**: Prefer real API testing for integration tests when possible
- **Mock for Speed**: Use mocks for unit tests and edge case testing
- **Test Isolation**: Each test should be independent and not rely on execution order
- **Clear Assertions**: Use descriptive assertion messages
- **Test Data**: Use fixtures and helpers for consistent test data
- **Full Test Passes**: Always output to file and provide monitoring (see [E2E Test README](test-app/tests/e2e/README.md))

### Running Full Test Passes

**‚ö†Ô∏è CRITICAL**: When running full test suites or comprehensive test passes:

1. **MUST send output to a file** for later analysis
2. **MUST provide real-time monitoring** so both you and collaborators can track progress

See [E2E Test README - Full Test Passes](test-app/tests/e2e/README.md#full-test-passes--important-use-file-output--monitoring) for required commands and best practices.

### Current Test Status

- Focus on maintaining and improving test coverage

## Git Branch Management

### CRITICAL: Never Delete Release Branches
- **NEVER delete branches that match the pattern `release/v*`** (e.g., `release/v0.6.5`, `release/v0.7.0`)
- Release branches are permanent historical references and must be preserved
- Even if a release branch appears "merged" to main, it should NOT be deleted
- Release branches serve as:
  - Historical reference points for specific releases
  - Documentation of release state at time of publication
  - Rollback points if needed
  - Reference for release documentation

### Branch Cleanup Rules
- **Safe to delete**: Feature branches (e.g., `davidrmcgee/issueXXX`, `issue-XXX`) that are:
  - Fully merged to main
  - Confirmed closed/resolved
  - No longer needed for reference
- **NEVER delete**:
  - Any branch matching `release/v*` pattern
  - Branches that are explicitly protected
  - Branches that might be needed for historical reference

### Before Deleting Any Branch
1. Verify it's not a release branch (check for `release/` prefix)
2. Confirm it's fully merged and no longer needed
3. Check if there are any open PRs or issues referencing it
4. When in doubt, DO NOT DELETE - ask the user first