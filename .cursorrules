# Cursor Rules for dg_react_agent

## Project Objectives

**Fork Purpose:** This fork of `dg_react_agent` adds `test-app` as a demonstration of a React web testable frontend to the dg_react_agent React component.

**API Compatibility Requirement:** The component MUST maintain API compatibility with the Deepgram Voice Agent API:
- Voice Agent API v1: https://developers.deepgram.com/docs/voice-agent
- Migration Guide: https://developers.deepgram.com/docs/voice-agent-v1-migration

Any improvements must be justified and maintain compatibility with the Voice Agent API.

**Test App Goals:** The test-app and its related tests are intended to:
- Recommend certain integration patterns and avoid others
- Act as a starting point for React developers
- Demonstrate proper usage of the headless dg_react_agent component
- MUST maintain API compatibility with the headless dg_react_agent component

## ‚ö†Ô∏è CRITICAL: Test-Driven Development (TDD)

**THIS PROJECT USES TEST-DRIVEN DEVELOPMENT. TESTS ALWAYS COME FIRST.**

### TDD Workflow (MANDATORY)

1. **üî¥ RED**: Write failing tests FIRST that define expected behavior
2. **üü¢ GREEN**: Implement minimal code to make tests pass
3. **‚ôªÔ∏è REFACTOR**: Improve code quality while keeping tests green
4. **üîÑ REPEAT**: Continue cycle for each feature increment

### TDD Rules

- **NEVER write implementation code without tests first**
- **NEVER skip writing tests** - tests are not optional
- **ALWAYS write tests before implementation** - this is non-negotiable
- **Tests define requirements** - tests serve as executable specifications
- **Red-Green-Refactor cycle** - follow this cycle for all development

### When Starting Any Feature or Bug Fix

1. **First**: Write failing tests that describe the desired behavior
2. **Second**: Run tests to confirm they fail (RED)
3. **Third**: Write minimal implementation to make tests pass (GREEN)
4. **Fourth**: Refactor code while keeping tests passing (REFACTOR)

### Test Requirements

- **Unit Tests**: Required for all component logic, utilities, and services
- **Integration Tests**: Required for WebSocket, audio, and cross-service interactions
- **E2E Tests**: Required for user-facing features and critical workflows
- **Test Coverage**: Maintain high coverage (>90% for critical paths)

### Test File Organization

- **Unit Tests**: `tests/` directory (Jest)
- **E2E Tests**: `test-app/tests/e2e/` directory (Playwright)
- **Test Utilities**: `tests/utils/` and `test-app/tests/helpers/`
- **Test Fixtures**: `tests/fixtures/` and `test-app/tests/fixtures/`

### Testing Standards

- **Test Naming**: Descriptive test names that explain what is being tested
- **Test Structure**: Arrange-Act-Assert pattern
- **Test Isolation**: Each test should be independent and not rely on other tests
- **Mock vs Real**: Prefer real API testing for integration, use mocks for unit tests
- **Test Documentation**: Tests should be self-documenting through clear naming

## Development Guidelines

### Fork Point
- Pre-fork: commit `7191eb4a062f35344896e873f02eba69c9c46a2d`
- Post-fork: all development after that point

### Voice Agent API Only
- The component uses ONLY the Deepgram Voice Agent API
- No Transcription API features should be used
- All `SpeechStarted` references in documentation/types should be removed or marked as deprecated

## Voice Agent API v1 Endpoint
- **CRITICAL**: Component uses Voice Agent v1 API endpoint
- ‚úÖ Correct endpoint: `wss://agent.deepgram.com/v1/agent/converse`
- ‚ùå NOT: `wss://agent.deepgram.com/agent` (deprecated early access)
- **Verification**: Check `src/types/connection.ts` line 27
- **API Specs**: https://github.com/deepgram/deepgram-api-specs

## Microphone Functionality
- **Preserve:** `startAudioCapture()` method (was present pre-fork)
- **Be cautious with:** `toggleMic()` and `microphoneEnabled` prop (added post-fork, may cause connection issues)
- **Test app expects:** `startAudioCapture()` method to be available via ref

## Component Architecture
- The component should be headless (no UI elements)
- Microphone control should primarily be handled by the test app, not the component
- The component should focus on WebSocket management and audio processing

## Testing Guidelines

### Test Types and When to Use Them

#### Unit Tests (Jest) - `tests/` directory
- **Purpose**: Test component logic, utilities, and services in isolation
- **When**: Testing individual functions, methods, or component behavior
- **Tools**: Jest, React Testing Library, mocks
- **Example**: Testing that functions are included in Settings message

#### Integration Tests (Jest) - `tests/` directory
- **Purpose**: Test interactions between components, services, and WebSocket
- **When**: Testing cross-service interactions, WebSocket message handling
- **Tools**: Jest, mocks for WebSocketManager and AudioManager
- **Example**: Testing Settings message sending and receiving

#### E2E Tests (Playwright) - `test-app/tests/e2e/` directory
- **Purpose**: Test complete user workflows with real API connections
- **When**: Testing full user flows, real API integration, critical paths
- **Tools**: Playwright, real Deepgram API (when available)
- **Example**: Testing full function calling flow from connection to execution

### Test run order and strategy

- **Real APIs first, then mocks** ‚Äî When API keys are available, run integration and E2E tests against the real upstream first (e.g. `USE_REAL_APIS=1 npm test -- tests/integration/openai-proxy-integration.test.ts`); then run the same or complementary tests with mocks. Location: `tests/integration/` (e.g. `openai-proxy-integration.test.ts`).
- **Then E2E** ‚Äî Run E2E tests (`test-app/tests/e2e/`) with real backend/APIs when configured, then extended E2E as needed.
- **CI always runs mocks** ‚Äî In CI, run only mock-based integration and E2E (no real API keys); keep CI fast and deterministic. See `docs/development/TEST-STRATEGY.md`.

### Test Utilities

- **MicrophoneHelpers**: Use for consistent microphone testing in E2E tests
- **Component Test Helpers**: `tests/utils/component-test-helpers.tsx` for component setup
- **WebSocket Capture**: Use `installWebSocketCapture()` for E2E WebSocket inspection
- **Audio Helpers**: `test-app/tests/e2e/fixtures/audio-helpers.js` for audio testing

### Testing Best Practices

- **Real API First**: Prefer real API testing for integration tests when possible
- **Mock for Speed**: Use mocks for unit tests and edge case testing
- **Test Isolation**: Each test should be independent and not rely on execution order
- **Clear Assertions**: Use descriptive assertion messages
- **Test Data**: Use fixtures and helpers for consistent test data

### Current Test Status

- Focus on maintaining and improving test coverage

## Backend / Proxy Defects ‚Äî Must Engage Real APIs

**Defects that involve the backend or proxy must actually engage with the real APIs presented by the provider.**

- **Real API, not mock-only:** Fixes for proxy/API behavior (e.g. message ordering, session.update, responseInProgress) must be validated against the **real** upstream (e.g. OpenAI Realtime API), not only mocks. The real API‚Äôs event order and timing can differ from mocks; production failures can persist if we only tested against a mock.
- **Partner-reported defects:** When a defect is **reported by a partner** (e.g. voice-commerce), we **must** add coverage that exercises the **reported scenario** (same flow, same provider) before considering the defect resolved and the release qualified. We may not add E2E variants for every case we develop, but **for partner-reported defects we must** ‚Äî either an E2E test that runs the partner‚Äôs scenario (e.g. function-call flow, real API) or an integration test that reproduces the same message/timing path against the real API. Mock-only or a different minimal path is **not** sufficient.
- **Function-call flow: real backend HTTP required.** Tests that qualify the function-call path (Settings ‚Üí user message ‚Üí FunctionCallRequest ‚Üí FunctionCallResponse ‚Üí response) **must** send FunctionCallResponse only after performing a **real HTTP request to a backend** (e.g. POST /function-call). **Never** qualify on a test that, on FunctionCallRequest, sends a hardcoded response from in-test code with no HTTP/backend. See `docs/issues/ISSUE-462/VOICE-COMMERCE-FUNCTION-CALL-REPORT.md`.

- **Lesson:** Issue #462 was reported by a partner; we fixed the proxy and added a real-API integration test that only probed Settings ‚Üí InjectUserMessage ‚Üí second Settings, and the function-call real-API test used an **in-test hardcoded** FunctionCallResponse (no HTTP, no backend). We did **not** add E2E (or equivalent) for the partner‚Äôs scenario (function calls, backend HTTP, full flow). That was insufficient. Do not repeat.

## Release Qualification (Real API) ‚Äî CRITICAL

**Never qualify a release on mock-only tests when the release fixes proxy/API behavior.**

- For any fix that depends on **upstream (proxy‚ÜîAPI) message ordering or timing** (e.g. openai-proxy, session.update, responseInProgress), we **must** run the relevant integration (and where applicable E2E) tests **against the real API** before marking the release qualified (or document an explicit exception).
- **Partner-reported defects:** Additionally, we **must** have coverage (E2E or integration against real API) that exercises the **partner‚Äôs scenario**; see ‚ÄúBackend / Proxy Defects‚Äù above.
- **Required when applicable:** Before release, run e.g. `USE_REAL_APIS=1 npm test -- tests/integration/openai-proxy-integration.test.ts` for proxy fixes (when OPENAI_API_KEY is available), and/or E2E in proxy mode with real backend. See release checklist and `.github/ISSUE_TEMPLATE/release-checklist.md` for the explicit qualification step.
- **References:** Issue #466 (process fix); Issue #462 / voice-commerce (partner-reported defect; we did not add E2E for the partner‚Äôs function-call scenario).

## Publishing and Releasing

- **Publishing the project** (npm packages to GitHub Package Registry) and the **tokens/secrets** required are documented in **docs/PUBLISHING-AND-RELEASING.md**.
- That doc covers: NPM_TOKEN (create/update, where it‚Äôs used), release flow, and pointers to the release checklist and workflow. Use it when updating an expired token or preparing a release.

## Git Branch Management

### CRITICAL: Never Delete Release Branches
- **NEVER delete branches that match the pattern `release/v*`** (e.g., `release/v0.6.5`, `release/v0.7.0`)
- Release branches are permanent historical references and must be preserved
- Even if a release branch appears "merged" to main, it should NOT be deleted
- Release branches serve as:
  - Historical reference points for specific releases
  - Documentation of release state at time of publication
  - Rollback points if needed
  - Reference for release documentation

### Branch Cleanup Rules
- **Safe to delete**: Feature branches (e.g., `davidrmcgee/issueXXX`, `issue-XXX`) that are:
  - Fully merged to main
  - Confirmed closed/resolved
  - No longer needed for reference
- **NEVER delete**:
  - Any branch matching `release/v*` pattern
  - Branches that are explicitly protected
  - Branches that might be needed for historical reference

### Before Deleting Any Branch
1. Verify it's not a release branch (check for `release/` prefix)
2. Confirm it's fully merged and no longer needed
3. Check if there are any open PRs or issues referencing it
4. When in doubt, DO NOT DELETE - ask the user first